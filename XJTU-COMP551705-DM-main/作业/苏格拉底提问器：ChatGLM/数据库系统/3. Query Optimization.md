# $\textbf{Query Optimization}$ 

# $\textbf{1. Storage}$â€‹ 

> ## $\textbf{1.1. File Hierarchy}$  
>
> > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/1043190004.png" alt="1043190004" style="zoom: 30%;" /> 
> >
> > |         æœ¯è¯­          |                             æè¿°                             |
> > | :-------------------: | :----------------------------------------------------------: |
> > | $\text{Record/Tuple}$ |                         è¡¨æ ¼ä¸­çš„ä¸€è¡Œ                         |
> > |     $\text{Page}$     | $\text{Fixed-size}$çš„æ•°æ®å—($\text{MySQL}$ä¸­ä¸º$\text{16KB}$) |
> > |     $\text{File}$     |                  åŒ…å«è‹¥å¹²å¤šçš„$\text{Page}$                   |
>
> ## $\textbf{1.2. File Orgnisation}$â€‹
>
> > |       æ–‡ä»¶ç±»å‹       |        å­˜æ”¾         |      è®°å½•çš„æ’åˆ—æ–¹å¼      |             é€‚ç”¨æƒ…å†µ             |
> > | :------------------: | :-----------------: | :----------------------: | :------------------------------: |
> > |  $\text{Heap file}$  | $\text{Data File}$  |     è®°å½•é—´æ— ç‰¹å®šé¡ºåº     | æ£€ç´¢æ‰€æœ‰è®°å½•($\text{Heap Scan}$) |
> > | $\text{Sorted file}$ | $\text{Data File}$  |   é¡µå’Œè®°å½•æŒ‰æŸæ¡ä»¶æ’åº   |        æŒ‰ç‰¹å®šé¡ºåºæ£€ç´¢è®°å½•        |
> > | $\text{Index file}$  | $\text{Index File}$ | å­˜æ”¾ç›®å½•ï¼ŒæŸé¡ºåºæ£€ç´¢æœ€å¿« |      å¿«é€Ÿæ£€ç´¢ç‰¹å®šé¡ºåºçš„è®°å½•      |
> >
> > **1ï¸âƒ£**$\text{Heap File}$ 
> >
> > 1. $\text{Data File}$ç»“æ„ï¼š$\text{Tuple}$æŒ‰é¡ºåºå¡«æ»¡ä¸€ä¸ªä¸ª$\text{Page}$ 
> >
> >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/18238755500.png" alt="18238755500" style="zoom: 39%;" /> 
> >
> > 2. ç‰¹ç‚¹ï¼š
> >
> >    - æ’å…¥å¿«ï¼šæ’å…¥è®°å½•æ—¶ï¼Œéšä¾¿æ’å…¥å“ªé‡Œ
> >    - æ‰«æå¿«ï¼šå³å¿«é€Ÿæ‰«ææ‰€æœ‰é¡µ($\text{Heap Scan}$)
> >    - æŸ¥æ‰¾æ…¢ï¼šè¦æƒ³æ‰¾åˆ°ä¸€ä¸ª$\text{Record}$ï¼Œéœ€è¦æŸ¥çœ‹æ¯æ¡è®°å½•
> >
> > 3. $\text{Heap Scan / Sequential Scan: }$æ‰«æè¡¨æ ¼ä¸­æ‰€æœ‰çš„$\text{Tuple}$ 
> >
> >    ```sql
> >    SELECT * FROM Table;
> >    ```
> >
> > **2ï¸âƒ£**$\text{Sorted File}$
> >
> > 1. $\text{Data File}$ç»“æ„ï¼š$\text{Pages and records are sorted}$, ä¸Šå›¾æ˜¯æ ¹æ®å¹´é¾„-è–ªæ°´å¤åˆæ’åº
> >
> >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/1218859907.png" alt="1218859907" style="zoom: 33%;" /> 
> >
> > 2. ç‰¹æ€§ï¼š
> >
> >    - æŸ¥æ‰¾å¿«ï¼šå¯¹äºæœ‰åºåºåˆ—ï¼Œå¯ä»¥ç”¨äºŒåˆ†æŸ¥æ‰¾
> >    - æ’å…¥æ…¢ï¼šä¸ºäº†ä¿è¯é¡ºåºï¼Œå°±ä¸èƒ½éšä¾¿æ’å…¥
> >
> > **3ï¸âƒ£**$\text{Index File}$ 
>
> ## $\textbf{1.3. Cost}$è¯„ä¼°æ ‡å‡†
>
> > **1ï¸âƒ£**$\text{DBMS}$è¯„ä¼°$\text{Transactions/Buffer Pool}$ç­‰æ“ä½œéœ€è¦å¼€é”€ï¼Œä½†æœ€ä¸»è¦çš„å¼€é”€æ˜¯$\text{IO}$æ“ä½œ
> >
> > **2ï¸âƒ£**å¼€é”€è¡¡é‡(å¿½ç•¥$\text{IO}$å¼€é”€ä»¥å¤–çš„å¼€é”€)ï¼š
> >
> > 1. $\text{DBMS}$çš„æ•°æ®å­˜å‚¨æ–¹å¼
> >
> >    | æ‰§è¡ŒæŸ¥è¯¢ |                å­˜å‚¨æ–¹å¼                 |           ä»‹è´¨           |
> >    | :------: | :-------------------------------------: | :----------------------: |
> >    |    âŒ     | å­˜å‚¨åœ¨$\text{Non-Volatile}$(éæ´»æ€§)ä»‹è´¨ | $\text{Hard Disk / SSD}$ |
> >    |    âœ”ï¸     |    å­˜å‚¨åœ¨$\text{Volatile}$(æ´»æ€§)ä»‹è´¨    |       $\text{RAM}$       |
> >
> > 2. è¡¡é‡ï¼š
> >
> >    - ç²—ç•¥è®¤ä¸ºå¼€é”€$\text{=IO}$å¼€é”€
> >    - $\text{IO}$å¼€é”€$\text{ }\propto{}\text{(}$ç¡¬ç›˜$\xrightarrow{\text{Data}}$ä¸»å­˜$\text{IO}$çš„é¡µæ•°$\text{)}$ 
>
> ## $\textbf{1.4. Index and Index File}$è¯¦è§£
>
> > ### $\textbf{1.4.1. Index}$æ¦‚è¿°
> >
> > > **1ï¸âƒ£**$\text{Index: }$ç›¸å½“äºä¸€ä¸ªç›®å½•/æŒ‡é’ˆï¼Œæ¯ä¸ª$\text{Index}$æŒ‡å‘ä¸€ä¸ª$\text{Data}$â€‹ 
> > >
> > > :two:$\text{Index File: }$
> > >
> > > 1. å­˜å‚¨$\text{Index}$çš„æ–‡ä»¶ï¼Œå»ºç«‹åœ¨$\text{Data File}$â€‹ä¹‹ä¸Š
> > > 2. å…è®¸å¿«é€Ÿæ£€ç´¢
> > > 3. ç›¸æ¯”$\text{Sorted File}$ï¼Œ$\text{Index}$å¯ä»¥åœ¨ä¸æ”¹å˜$\text{Data File}$çš„æƒ…å†µä¸‹ï¼Œå»ºç«‹å¤šç§æ’åºæ–¹å¼
> > >
> > > :three:$\text{Index Key}$
> > >
> > > 1. $\text{Search Key Field}$â€‹(æœç´¢å…³é”®å­—å­—æ®µ): 
> > >
> > >    - å…¶å®å°±æ˜¯é€‰å–è‡ªè¡¨æ ¼çš„$\text{Column}$ 
> > >
> > >    - ç”¨äºå»ºç«‹ç´¢å¼•çš„ç‰¹å®šå­—æ®µ($\text{Fields}$)ï¼Œæ¯”å¦‚æŒ‰å¹´é¾„æ’åº
> > >
> > > 2. ==$\text{Composite Search Key}$== 
> > >
> > >    - ä»¥æ¯”å¦‚`<Age, Sal, Name>`å…ˆæŒ‰`Age`æ’åºå†æŒ‰`Sal`æ’åºæœ€åæŒ‰`Name`æ’åº
> > >
> > >    - é‡ç‚¹å…³æ³¨$\text{Index}$â€‹çš„é¡ºåº
> >
> > ### $\textbf{1.4.2. Indexing Implementation: Hash/B}^{+}\textbf{Tree Index}$ 
> >
> > > **==å†³å®š$\text{Index File}$â€‹çš„é¡ºåº==**
> > >
> > > **1ï¸âƒ£**$\text{B}^{+}\text{Tree Index}$: 
> > >
> > > 1. $\text{Index File}$â€‹ç»“æ„ç»“æ„
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240421165933628.png" alt="image-20240421165933628" style="zoom:49%;" />  
> > >
> > >    | $\textbf{Index File}$ç»“æ„ç»“æ„ |                            ç‰¹ç‚¹                             |
> > >    | :---------------------------: | :---------------------------------------------------------: |
> > >    |  $\text{Leaf Node}$(æœ€åº•å±‚)   | åŒ…å«==æ‰€æœ‰==å¯èƒ½çš„å€¼$\text{Data Entries}$(è¿™ç‚¹ä¸åŒäºäºŒå‰æ ‘) |
> > >    |           ä¸­é—´èŠ‚ç‚¹            |     ç›¸å½“äº$\text{Guiding}$çš„ä½œç”¨ï¼ŒåŒ…å«æŒ‡å‘ä¸‹ä¸€å±‚çš„æŒ‡é’ˆ      |
> > >
> > > 2. ç‰¹ç‚¹ï¼š
> > >
> > >    - $\text{Index File}$æœ‰åº
> > >    - å¯¹$\text{Range Search}$å’Œ$\text{Equality Search}$æ•ˆæœéƒ½å¾ˆå¥½
> > >
> > > **2ï¸âƒ£**$\text{Hash Index}$
> > >
> > > 1. å“ˆå¸Œæ˜¯ä»€ä¹ˆï¼š$\text{Key(Record)}\xrightarrow{\text{Hashå‡½æ•°}}\text{Hashå€¼}\xrightarrow{\text{ä¸€ä¸ªHashå€¼å¯¹åº”ä¸€ä¸ªBucket}}æ”¾å…¥å¯¹åº”æ¡¶$ 
> > >
> > >    | $\textbf{Record}$ | $\textbf{Key}$ | $\textbf{Hash}$ | $\textbf{Bucket}$  |
> > >    | :---------------: | :------------: | :-------------: | :----------------: |
> > >    |  $\text{Alice}$   |   $\text{A}$   |   $\text{1}$    | $\text{1}$å¯¹åº”çš„æ¡¶ |
> > >    |   $\text{Bob}$    |   $\text{B}$   |   $\text{2}$    | $\text{2}$å¯¹åº”çš„æ¡¶ |
> > >    |  $\text{David}$   |   $\text{D}$   |   $\text{4}$    | $\text{4}$å¯¹åº”çš„æ¡¶ |
> > >
> > > 2. $\text{Hash Index}$â€‹åŸç†ï¼šå“ˆå¸Œå‡½æ•°$\text{H=Sal(Mod4)}$ â€‹
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image.png" alt="image" style="zoom:50%;" /> 
> > >
> > >    - å…ˆç¡®å®šè¦æŸ¥æ‰¾çš„æ•°åœ¨å“ªä¸ª$\text{Bucket}$ä¸­
> > >    - å†åˆ°ç›¸åº”$\text{Bucket}$â€‹ä¸­å¯»æ‰¾ï¼Œæ‰¾åˆ°åå†ç´¢å¼•åˆ°$\text{Data File}$ä¸­
> > >
> > > 3. ç‰¹ç‚¹ï¼š$\text{Index File}$æŒ‰$\text{Bucket}$æ’åˆ—$\text{â†’Index File}$æ— åº
> > >
> > >    - æéš¾ä½œ$\text{Range Search}$(<span style="color:red;">è¿˜ä¸å¦‚ç›´æ¥$\text{Heap Scan}$</span>)ï¼Œ==åªèƒ½ä½œ$\text{Equality Search}$â€‹== 
> > >    
> > >      ```sql
> > >      SELECT * FROM A>10 -- è‹¥Aå»ºç«‹åœ¨HASHç´¢å¼•ä¸Šï¼Œè¿™ä¸€è¡Œæ•ˆç‡æœ€é«˜çš„æ°æ°æ˜¯Heap Scan
> > >      ```
> > >    
> > >    - å†å»è®©$\text{Hash Index}$ä½œ$\text{Cluster}$æ— æ„ä¹‰ï¼Œå› ä¸º$\text{Data}$é¡ºåºç­‰äº/ä¸ç­‰äºæ— åºçš„$\text{Index}$éƒ½æ— æ„ä¹‰ 
> >
> > ### $\textbf{1.4.3. Index Storage: Cluster/Uncluster Index}$ 
> >
> > > **==å†³å®š$\text{Data File}$é¡ºåº(æ— åº/ä¸$\text{Index File}$â€‹é¡ºåºä¸€è‡´)==**
> > >
> > > **1ï¸âƒ£**$\text{Cluster/Uncluster Index}$â€‹æ¦‚è¿°
> > >
> > > 1. åŸç†
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240421162644005.png" alt="image-20240421162644005" style="zoom:55%;" />   
> > >
> > >
> > >    |     $\textbf{Type}$      |        $\textbf{Data File}$        |
> > >    | :----------------------: | :--------------------------------: |
> > >    |  $\text{Cluster Index}$  | æœ‰åºï¼Œä¸”==æŒ‰ç…§$\text{Index}$æ’åº== |
> > >    | $\text{Uncluster Index}$ |     æ— åºï¼Œå³$\text{Heap File}$     |
> > >
> > > 2. æ³¨æ„äº‹é¡¹ï¼š
> > >
> > >    - ä¸€ä¸ªè¡¨æ ¼çš„$\text{Cluster Index}$å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œå› ä¸ºå…¶æŒ‰ç…§$\text{Index}$â€‹æ’åº
> > >    - $\text{Cluster/Uncluster Index}$çš„æ¦‚å¿µå¾ˆå¤§ç¨‹åº¦æ˜¯åªåº”ç”¨åœ¨$\text{B}^{+}\text{Tree Index}$ï¼Œè€Œé$\text{Hash}$ä¸Šçš„
> > >
> > > **2ï¸âƒ£**$\text{Cluster/Uncluster Index}$çš„$\text{Range Scan}$å¼€é”€ï¼šä¾‹å¦‚è¦æœç´¢æˆç»©åœ¨$\text{10â†’50}$çš„å­¦ç”Ÿ 
> > >
> > > |  $\textbf{Type}$   |              å¼€é”€               |                     ç¤ºä¾‹                      |
> > > | :----------------: | :-----------------------------: | :-------------------------------------------: |
> > > |  $\text{Cluster}$  |     å­˜æ”¾æ‰€éœ€èŒƒå›´æ•°æ®çš„é¡µæ•°      | å‡è®¾$\text{10â†’50}$å­˜æ”¾åœ¨$3$é¡µä¸­$\to$å¼€é”€æ˜¯$3$ |
> > > | $\text{Uncluster}$ | ç¬¦åˆè¦æ±‚çš„$\text{Data Entry}$æ•° |               æœ€åæƒ…å†µ$40(41)$                |
> > >
> > > 1. $\text{Cluster Index}$å¼€é”€åŸç†
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240510140340276.png" alt="image-20240510140340276" style="zoom: 50%;" />  
> > >
> > > 2. $\text{Uncluster Index}$å¼€é”€åŸç†ï¼šæœ€åçš„æƒ…å†µï¼Œæ¯è¯»ä¸€ä¸ªæ•°æ®éƒ½è¦$\text{IO}$ä¸€é¡µ
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240510141358438.png" alt="image-20240510141358438" style="zoom:50%;" /> 
> >
> > ### $\textbf{1.4.3. Index Role: Primary/Secondary Index}$
> >
> > > |  $\textbf{Type}$   |   $\textbf{Search Key}$    | $\textbf{Duplicates}$ |             ç¤ºä¾‹              |
> > > | :----------------: | :------------------------: | :-------------------: | :---------------------------: |
> > > |  $\text{Primary}$  |  åŒ…å«$\text{Primary Key}$  |        ä¸å­˜åœ¨         | æŒ‰ç…§`Student.ID`æ’åºå»ºç«‹ç´¢å¼•  |
> > > | $\text{Secondary}$ | ä¸åŒ…å«$\text{Primary Key}$ |       å¯èƒ½å­˜åœ¨        | æŒ‰ç…§`Student.Age`æ’åºå»ºç«‹ç´¢å¼• |

# $\textbf{2. Query Processing}$

> ## $\textbf{2.1. SELECTION Processing}$
>
> > ### $\textbf{2.1.1. }$æœ‰å…³å‚æ•°ï¼š==é«˜äº®ä¸º$\text{SELECTION}$å¼€é”€å†³å®šå‚æ•°== 
> >
> > > :one:åŸºç¡€å‚æ•°
> > >
> > > |         $\textbf{Factor}$         | å«ä¹‰                                 |
> > > | :-------------------------------: | :----------------------------------- |
> > > |      ==$\text{NPages(I)}$==       | $\text{Index File}$ä¸€å…±æœ‰å¤šå°‘é¡µ      |
> > > |        $\text{NTuples(R)}$        | $\text{Data File}$ä¸€å…±æœ‰å¤šå°‘æ¡æ•°æ®   |
> > > |        $\text{NPages(R)}$         | $\text{Data File}$ä¸€å…±æœ‰å¤šå°‘é¡µ       |
> > > | $\text{NTuplesPerPage}\text{(R)}$ | $\text{Data File}$æ¯é¡µå­˜æ”¾å¤šå°‘æ¡æ•°æ® |
> > >
> > > - $\text{NTuples(R)=}\text{NPages(R)}\times\text{NTuplesPerPage}\text{(R)}$ 
> > >
> > > **2ï¸âƒ£**æŸ¥è¯¢ä¼˜åŒ–å‚æ•°
> > >
> > > |             $\textbf{Factor}$             | å«ä¹‰                                         |
> > > | :---------------------------------------: | :------------------------------------------- |
> > > |       ==$\text{Result Size(RS)}$==        | $\text{Data File}$ä¸€å…±æœ‰å¤šå°‘é¡µ**æ˜¯éœ€è¦çš„**   |
> > > | $\text{Reduction Factor(RF)/Selectivity}$ | æœ‰å¤šå°‘ç™¾åˆ†æ¯”çš„æ•°æ®ç¬¦åˆ$\text{SELECTION}$æ¡ä»¶ |
> > >
> > > 1. åŸç†ï¼š$\text{NPages(R)(å…³ç³»å¤§å°)}\xrightarrow[å‰©ä¸‹çš„]{ç»è¿‡\text{WHERE + Condition}ç­›é€‰}\text{RS}$ï¼Œå³$\text{RS = NPages(R)Ã—RF}$  
> > > 2. ç¤ºä¾‹ï¼šæ•´ä¸ªè¡¨æ ¼æœ‰$\text{100}$é¡µï¼Œç»è¿‡`WHERE+condition`ç­›é€‰ååªæœ‰$\text{20}$é¡µï¼Œé‚£$\text{RS=20, RF=0.2}$ 
> >
> > ### $\textbf{2.1.2. SELECTION Cost}$
> >
> > > **1ï¸âƒ£**éç´¢å¼•æƒ…å†µä¸‹çš„å¼€é”€($\text{Sorted File}$åŸºæœ¬ä¸è€ƒ)
> > >
> > > | $\textbf{File Structure}$ |     $\textbf{Cost}$(å•ä½æ˜¯$\textbf{IO}$æ¬¡æ•°)     |               åŸç†               |
> > > | :-----------------------: | :----------------------------------------------: | :------------------------------: |
> > > |    $\text{Heap File}$     |                $\text{NPages(R)}$                | $\text{Heap Scan}$è¯»å–è¡¨ä¸­æ¯ä¸€é¡µ |
> > > |   $\text{Sorted File}$    | $\log_{2}\text{[NPages(R)]+RFÃ—}\text{NPages(R)}$ |   äºŒåˆ†æŸ¥æ‰¾å®šä½$+$æ‰€éœ€è¯»å¤šå°‘é¡µ    |
> > >
> > > **2ï¸âƒ£**ç´¢å¼•æƒ…å†µä¸‹çš„å¼€é”€
> > >
> > > |   $\textbf{Index}$å®ç°    |   $\textbf{Index}$å­˜å‚¨/è§’è‰²    |                             å¼€é”€                             |
> > > | :-----------------------: | :----------------------------: | :----------------------------------------------------------: |
> > > | $\text{B}^{+}\text{Tree}$ |     $\text{Primary Index}$     |                 $\text{æ ‘é«˜Height(Index)+1}$                 |
> > > |       $\text{Hash}$       |     $\text{Primary Index}$     |     $\text{ProbeCost(Index)+1}\xrightarrow{é»˜è®¤ä¸º}1.2+1$     |
> > > | $\text{B}^{+}\text{Tree}$ | ==$\text{Unclustered index}$== | $\text{[NPages(I)+N\textcolor{red}{Tuples}(R)]Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}$ |
> > > | $\text{B}^{+}\text{Tree}$ |  ==$\text{Clustered index}$==  | $\text{[NPages(I)+N\textcolor{red}{Pages}(R)]Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}$ |
> > > |       $\text{Hash}$       |   $\text{Unclustered index}$   | $\text{N\textcolor{red}{Tuples}(R)Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}\times{}2.2$ |
> > > |       $\text{Hash}$       |    $\text{Clustered index}$    | $\text{N\textcolor{red}{Pages}(R)Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}\times{}2.2$ |
> > >
> > > 1. $\text{Unclustered/Clustered index}$çš„ä¸¤éƒ¨åˆ†å¼€é”€ä¸ºè¯»å–æ‰€éœ€$\text{Index+Page}$
> > > 2. $\text{Unclustered index}$ä¸­$\text{NTuples(R)}$æ˜¯å› ä¸ºæ­¤æ—¶è¯»å–éœ€è¦åå¤å›åˆ°$\text{Index File}$â€‹
> > > 3. å¤šä¸ª$\text{RF}$â€‹éƒ½éœ€è¦ä¹˜èµ·æ¥ï¼Œè‡³äºæœ‰å¤šå°‘ä¸ªï¼Œå–å†³äº`WHERE`å­å¥åé¢æ˜¯ä»€ä¹ˆ
> >
> > ### $\textbf{2.1.3. SELECTION Cost}$è¡¥å……ï¼š$\textbf{RF Estimate}$ 
> >
> > > #### $\textbf{2.1.3.1. }$åŸºæœ¬å‡è®¾: $\textbf{Assume Uniform Distribution}$ 
> > >
> > > > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/82928265853.png" alt="82928265853" style="zoom: 38%;" /> 
> > >
> > > #### $\textbf{2.1.3.2. }$$\textbf{RF Estimate}$ 
> > >
> > > > **1ï¸âƒ£**ç®€å•æƒ…å†µä¸‹çš„$\text{RF}$ä¼°ç®—
> > > >
> > > > 1. å‚æ•°å«ä¹‰
> > > >
> > > >    |        å‚æ•°         |                    å«ä¹‰                    |
> > > >    | :-----------------: | :----------------------------------------: |
> > > >    | $\text{NKeys(Col)}$ | ä¸€åˆ—ä¸­å«æœ‰å¤šå°‘ç§ç‹¬ä¸€æ— äºŒçš„å€¼ï¼Œå³`DISTINCT` |
> > > >    | $\text{High(Col)}$  |               ä¸€åˆ—ç§çš„æœ€é«˜å€¼               |
> > > >    |  $\text{Low(Col)}$  |               ä¸€åˆ—ç§çš„æœ€ä½å€¼               |
> > > >
> > > > 2. ç¦»æ•£å˜é‡çš„$\text{RF}$â€‹ä¼°ç®—ï¼š`WHERE Col=Value`
> > > >
> > > >    - ${}\text{Col=Value}$å¯¹åº”å•ä¸ªå€¼æ—¶ï¼Œ$\text{RF=}\cfrac{\text{1}}{\text{NKeys(Col)}}$ 
> > > >
> > > >      ```sql
> > > >      WHERE level=5;
> > > >      ```
> > > >
> > > >    - ${}\text{Col=Value}$å¯å¯¹åº”å¤šä¸ªå€¼ï¼Œæ¯”å¦‚ä»¥ä¸‹æƒ…å†µæœ‰$\text{X}$ä¸ª$\text{Value}$ï¼Œåˆ™$\text{RF=}\cfrac{\text{X}}{\text{NKeys(Col)}}$ 
> > > >
> > > >      ```sql
> > > >      WHERE level=1 AND level=2 AND ... AND level=X;
> > > >      ```
> > > >
> > > >    - ç¦»æ•£å˜é‡çš„ä¸ç­‰$\xrightarrow{è½¬åŒ–}$ç›¸ç­‰ï¼Œå¦‚ä¸‹$\text{Level>7}\Rightarrow\text{Level=8,9,10}\Rightarrow\text{Num=3}$ 
> > > >
> > > >      ```sql
> > > >      WHERE level>1 -- å…±10ä¸ªlevel
> > > >      ```
> > > >
> > > >      æ¯”å¦‚â€‹ 
> > > >
> > > > 3. è¿ç»­å˜é‡çš„$\text{RF}$ä¼°ç®—ï¼š`WHERE Col>Value / WHERE Col<Value ` 
> > > >
> > > >    |        æ¡ä»¶        |                      $\textbf{RF}$ç­‰äº                       | $\textbf{SQL}$ç¤ºä¾‹ |
> > > >    | :----------------: | :----------------------------------------------------------: | :----------------: |
> > > >    | $\text{Col>Value}$ | $\cfrac{\text{High(Col)}-\text{Value}}{\text{High(Col)}-\text{Low(Col)}}$ |      `time>8`      |
> > > >    | $\text{Col<Value}$ | $\cfrac{\text{Value}-\text{Low(Col)}}{\text{High(Col)}-\text{Low(Col)}}$ |      `time<8`      |
> > > >
> > > > **2ï¸âƒ£**$\text{Join}$æ“ä½œä¸‹çš„$\text{RF}$ä¼°ç®—ï¼š$\text{RF}=\cfrac{1}{\text{Max[NKeys(JoinCol\_A), NKeys(JoinCol\_B)]}}$ 
> > > >
> > > > 1. ç¤ºä¾‹ï¼š$\text{Student/Subject}$æ˜¯ä¸¤ä¸ª$\text{JoinCol}$
> > > >
> > > >    ```sql
> > > >    Student INNER JOIN Subject ON Student.stuid=Subject.stuid
> > > >    ```
> > > >
> > > >
> > > > 2. æ ¸å¿ƒï¼š$\text{Primary Key}$æ‰€åœ¨åˆ—$\text{JoinCol}$â€‹å”¯ä¸€å€¼æ›´å¤šâ€‹
> > > >
> > > >    - å‡è®¾`stuid`åœ¨$\text{Student}$å¤„ä¸º$\text{PK}$ï¼Œåœ¨$\text{Subject}$å¤„ä¸º$\text{FK}$ 
> > > >
> > > >    - åˆ™ï¼š$\text{RF}=\cfrac{1}{\text{NTuples(Student)}}$ 
> > > >
> > > > 3. ç‰¹æ®Šæƒ…å†µï¼šè‹¥$\text{Student}$ç­›é€‰å‰©ä¸‹$\text{20\%}$å†å»$\text{Join}$ï¼Œ$\text{RF}$è®¡ç®—æ— éœ€$\text{Ã—20\%}$ï¼Œæ°¸è¿œä¿æŒåŸæ¥çš„å¤§å°
> > > >
> > > >    - åŸç†ï¼š$\text{Subject}$ä¸­è¿˜æœ‰æœªè¢«ç­›é€‰çš„é‚£$\text{80\% Student}$â€‹æ•°æ®ï¼Œå³è¿™äº›å€¼æ˜¯è¢«ç­›æ‰è€Œä¸æ˜¯åˆ æ‰
> > > >
> > > >    - å¦‚ä¸‹ä¾‹å­ä¸­ï¼šä¸¤ç§æƒ…å†µä¸‹$\text{NLJ}$éƒ½æœ‰$\text{RF}=\text{RF(Test}\bowtie{}\text{DTR)}$â€‹   
> > > >
> > > >      <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/41570539127.png" alt="41570539127" style="zoom:39.9%;" /> 
> > > >
> > > > **3ï¸âƒ£**ç„å­¦æƒ…å†µï¼šæ¯”å¦‚å‘Šè¯‰ä½ `age=5`ä½†æ˜¯ä¸å‘Šè¯‰ä½ `DISTINCT age`çš„æ•°é‡ï¼Œåˆ™é»˜è®¤$\text{RF=}\cfrac{1}{10}$
> > >
> > > #### $\textbf{2.1.3.3. }$$\textbf{RF Estimate}$ä¼˜åŒ– 
> > >
> > > > :one:å­˜åœ¨çš„é—®é¢˜ï¼šæ•°æ®ä¸å¯èƒ½æ˜¯å¹³å‡åˆ†å¸ƒçš„ï¼Œå¦‚æœæ•°æ®é›†ä¸­å‘ä¸€ä¸ªæ–¹å‘é è¿‘ï¼Œè¯¯å·®å°±ä¼šå¾ˆå¤§
> > > >
> > > > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240512175609718.png" alt="image-20240512175609718" style="zoom: 43%;" /> 
> > > >
> > > > :two:è¯¯å·®åˆ†æ
> > > >
> > > > 1. æ–¹æ³•$\text{1: Variable-Width Histogram}$â€‹(æŸ±çŠ¶å›¾)
> > > >
> > > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240512180432571.png" alt="image-20240512180432571" style="zoom:40%;" /> 
> > > >
> > > >    - åˆ†$\text{Bucket}\to{}$å°½é‡æ¯ä¸ª$\text{Bucket}$ä¸­æ•°é‡å·®ä¸å¤š$\to{}$å†å»ç”¨$\text{Bucket}$ä¼°è®¡
> > > >
> > > >    - ä¼°ç®—`age=5`(åœ¨$\text{Bucket1}$é‡Œ)ï¼š$\text{RF=}\cfrac{1}{å…±4ä¸ª\text{Bucket}\times{}\text{Bucket1}é‡Œæœ‰5ä¸ªå€¼}=\cfrac{1}{20}$
> > > >
> > > > 2. æ–¹æ³•$\text{2: }$å–æ ·å‡ºä¸€éƒ¨åˆ†æ•°æ®ï¼Œå¾—å‡ºå¤§è‡´çš„æ•°æ®åˆ†å¸ƒ
> > 
> > ### ==$\textbf{2.1.4. SELECTION Condition: }$å¦‚ä½•å¤„ç†`WHERE`å­å¥==
> >
> > > **1ï¸âƒ£**åŸç†
> >>
> > > 1. å¯»æ‰¾æœ€ä¾¿å®œçš„$\text{Access Path}$ï¼šä¼°ç®—æˆæœ¬($\text{IO}$æ¬¡æ•°)
> > >    - åˆ©ç”¨==ç´¢å¼•åŒ¹é…çš„è°“è¯==æ¥è®¡ç®—$\text{RF}$ï¼Œä»è€Œè¾¾åˆ°ç®€åŒ–æ•ˆæœâ€‹
> > >    - $\text{Apply other predicates on-the-fly}$(å®æ—¶)
> > > 2. é€‰å–æˆæœ¬æœ€å°çš„æ–¹å¼($\text{Index}$æˆ–$\text{File Scan}$)
> > >
> > > **2ï¸âƒ£**ç´¢å¼•åŒ¹é…çš„è°“è¯ï¼š$\text{Composite Search Key}$ä¸`WHERE + Condition`åŒ¹é…
> > >
> > > 1. åŒ¹é…æ¡ä»¶ï¼š
> > >
> > >    - `WHERE + Condition`è¦åŒ…å«$\text{Composite Search Key}$çš„$\text{Prefix}$â€‹
> > >    - `WHERE + Condition`ä¸­`AND`çš„é¡ºåºä¸é‡è¦
> > >
> > > 2. åŒ¹é…ç¤ºä¾‹ï¼š`<a,b,c>`çš„$\text{Prefix}$åŒ…å«`a/ab/abc`
> > >
> > >    | $\textbf{Composite Search Key}$ | $\textbf{ WHERE Conditions}$ | åŒ¹é…çš„$\textbf{Prefix}$ |
> > >    | :-----------------------------: | :--------------------------- | :---------------------- |
> > >    |            `<a,b,c>`            | `WHERE a=1`                  | `a`                     |
> > >    |            `<a,b,c>`            | `WHERE a=1 AND b=2`          | `a,b`                   |
> > >    |            `<a,b,c>`            | `WHERE a=1 AND b=2 AND c=3`  | `a,b,c`                 |
> > >    |            `<a,b,c>`            | `WHERE a=1 AND b=2 AND d=3`  | `a,b`                   |
> > >    |            `<a,b,c>`            | `WHERE a=1 AND c=2`          | `a`                     |
> > >    |            `<a,b,c>`            | `WHERE b=2 AND c=3`          | `NULL`                  |
> > >
> > > **3ï¸âƒ£**åŸºäºç´¢å¼•åŒ¹é…çš„è°“è¯çš„$\text{RF}$â€‹è®¡ç®—ç¤ºä¾‹
> > >
> > > | $\textbf{Composite Search Key}$ | $\textbf{ WHERE Conditions }$ | $\textbf{Prefix}$ |    $\textbf{RF}$    |
> > > | :-----------------------------: | :---------------------------- | :---------------: | :-----------------: |
> > > |            `<a,b,c>`            | `WHERE a AND c`               |        `a`        |   $\text{RF(a)}$    |
> > > |             `<a,c>`             | `WHERE a AND b AND c`         |       `a,c`       | $\text{RF(a)RF(c)}$ |
> > >
> > > **4ï¸âƒ£**å…¶ä»–æ³¨æ„äº‹é¡¹ï¼š$\text{Hash}ä¸èƒ½ä½œ\text{Range Search}$ï¼Œè§å¦‚ä¸‹çš„ç»¼åˆç¤ºä¾‹ä¸­$\text{Day}$æ˜¯$\text{Range Search}$
> > >
> > > ```sql
> > > WHERE day<8/9/94 AND bid=5 AND sid=3
> > > ```
> > >
> > > |      $\textbf{Type}$      | $\textbf{Index}$ | $\textbf{Prefix}$ |      æ˜¯å¦é€‚ç”¨äºç¤ºä¾‹çš„æŸ¥è¯¢       |      $\textbf{RF}$       |
> > > | :-----------------------: | :--------------: | :---------------: | :-----------------------------: | :----------------------: |
> > > | $\text{B}^{+}\text{Tree}$ |  `<rname,day>`   |   $\text{N/A}$    | $\text{N}(æ— åŒ¹é…\text{Prefix})$ |        $\text{1}$        |
> > > | $\text{B}^{+}\text{Tree}$ |  `<day,rname>`   |       `day`       |           $\text{Y}$            |     $\text{RF(day)}$     |
> > > | $\text{B}^{+}\text{Tree}$ |   `<day,sid>`    |     `day,sid`     |           $\text{Y}$            | $\text{RF(day)*RF(sid)}$ |
> > > |       $\text{Hash}$       |  `<day,rname>`   |       `day`       |  $\text{N(Hashä¸èƒ½èŒƒå›´æœç´¢)}$   |        $\text{1}$        |
> > >
> > > - æ³¨æ„ä¸€ä¸ªç»†èŠ‚ï¼šè¿™é‡Œçš„$\text{B}^{+}\text{Tree}$æ— è®ºæ˜¯$\text{Cluster/Uncluster}$ï¼Œéƒ½æ— å…³ç´§è¦
>
> ## $\textbf{2.2. Projection}$(å¾ˆå°‘è€ƒ)
>
> > ### $\textbf{2.2.1. Overview}$ 
> >
> > > **1ï¸âƒ£**æŠ•å½±$\text{Process}$çš„æµç¨‹
> > >
> > > |             åœºæ‰€             | æ“ä½œ                                         |
> > > | :--------------------------: | -------------------------------------------- |
> > > |       ç£ç›˜$\to{}$å†…å­˜        | è¯»å–$\text{Data File}$ä¸­æ‰€æœ‰è¦å¤„ç†çš„é¡µåˆ°å†…å­˜ |
> > > |       å†…å­˜$\to{}$ç£ç›˜        | åœ¨å†…å­˜ä¸­æŠ•å½±(ç­›æ‰ä¸€äº›é¡µ)ï¼Œå‰©ä¸‹é¡µå†™å›ç£ç›˜     |
> > > | ç£ç›˜(ä½†æ’åºæ—¶ä¸æ–­å’Œå†…å­˜äº¤æ¢) | å¯¹æŠ•å½±åçš„é¡µè¿›è¡Œæ’åº                         |
> > > |       ç£ç›˜$\to{}$å†…å­˜        | å°†æŠ•å½±+æ’åºåçš„é¡µï¼Œé‡æ–°è¯»å›å†…å­˜              |
> > >
> > > **2ï¸âƒ£**ä¸ºä½•$\text{Projection}$æ“ä½œä¸­éœ€è¦$\text{Sort}$
> > >
> > > |                  åŸå›                    | è§£é‡Š                                                         |
> > > | :-------------------------------------: | ------------------------------------------------------------ |
> > > |            æ”¯æŒ`DISTICT`æ“ä½œ            | ==å»é‡æ—¶==ï¼Œå¦‚æœæ•°æ®å·²ç»æ’åºï¼Œé‚£ä¹ˆåˆå¹¶ç›¸é‚»çš„ç›¸åŒè®°å½•å³å¯     |
> > > | æé«˜$\text{B}^{+}\text{Tree}$çš„åŠ è½½æ•ˆç‡ | å·²æ’åºçš„æ•°æ®æ’å…¥$\text{B}^{+}\text{Tree}$æ—¶ï¼Œä¸å¤ªå¯èƒ½å¯¼è‡´å¤§é‡çš„èŠ‚ç‚¹é‡æ–°åˆ†é… |
> > > |           ä¼˜åŒ–`GROUP BY`æ“ä½œ            | æ¯”å¦‚æŒ‰ç…§`Age`åˆ†ç±»ï¼Œéœ€è¦ç›´åˆ°æœ‰å‡ ç§`Age`ï¼Œé‚£å°±éœ€è¦æ’åº         |
> > >
> > > - å…³äº==å»é‡==ï¼š$\text{Projection}$å¯èƒ½ä¼š$\text{Removing duplicates}$ï¼Œä¾‹å¦‚å‡è®¾$\text{20}$ä¸ªå‘˜å·¥éš¶å±äº$\text{4}$â€‹ä¸ªéƒ¨é—¨
> > >
> > >   ```sql
> > >   SELECT Depart FROM Employees;         -- è¿”å›20ä¸ªå‘˜å·¥çš„20ä¸ªéƒ¨é—¨(å…±20è¡Œ)
> > >   SELECT DISTINCT Depart FROM Employees;-- è¿”å›20ä¸ªå‘˜å·¥çš„4ç§éƒ¨é—¨(å…±4è¡Œ)
> > >   ```
> > >
> > > **3ï¸âƒ£**$\text{Projection Factor(PF)}$ 
> > >
> > > 1. æ˜¯æŠ•å½±å¤„ç†çš„å†³å®šå› ç´ 
> > > 2. å³é€‰å–çš„$\text{Column}$å $\text{Column}$æ€»æ•°çš„æ¯”ï¼Œä¾‹å¦‚æ€»å…±åä¸ªå±æ€§$\text{Project}$ä¸¤ä¸ªï¼Œåˆ™$\text{PF=0.2}$ 
> >
> > ### $\textbf{2.2.2. External Merge Sort: Divide \& Conquer}$(åˆ†æ²»)
> >
> > > **1ï¸âƒ£**æ’åºåŸç†
> > >
> > > |  $\textbf{Trem}$   |                   å«ä¹‰                    |
> > > | :----------------: | :---------------------------------------: |
> > > |  $\text{Passes}$   |     æ’åºè¿‡ç¨‹ä¸­æ•°æ®è¯»å†™ç¡¬ç›˜çš„å¾ªç¯æ¬¡æ•°      |
> > > | $\text{NumPasses}$ | $\text{Passes}$æ•°é‡(åˆ†å¤šå°‘æ¬¡å¯ä»¥å®Œæˆæ’åº) |
> > > |   $\text{Runs}$    |            å·²æ’åºçš„æœ‰åºæ•°æ®æ®µ             |
> > > |   $\text{N-Way}$   |     æ¯æ¬¡åˆå¹¶$\text{N}$ä¸ª$\text{Runs}$     |
> > >
> > > 1. åˆ†å‰²æ•´ä¸ªæ•°æ®é›†ä¸ºå¤šä¸ªå°$\text{Runs}\to{}$æ¯ä¸ª$\text{Runs}$åŠ è½½è¿›å†…å­˜æ’å¥½åº$\to{}$æ’åºåçš„$\text{Runs}$å†™å›ç£ç›˜
> > > 2. å°†ç£ç›˜ä¸­çš„$\text{Runs}$æœ‰åºåˆå¹¶ä¸ºæœ‰å…³å¤§çš„$\text{Runs}$â€‹
> > >
> > > ğŸ˜­é‡‡ç”¨$\text{External}$æ’åºçš„åŸå› åœ¨äºå†…å­˜ä¸å¤Ÿå¤§ï¼Œéœ€è¦è½®æ¢è¿›å…¥å†…å­˜
> > >
> > > **2ï¸âƒ£**$\text{2-Way External Merge Sort}$ç¤ºä¾‹
> > >
> > > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/33983312621.png" alt="33983312621" style="zoom:55%;" />  
> > >
> > > |    $\textbf{Trem}$     |               $\textbf{Value}$               |                      $\textbf{E.g.}$                       |
> > > | :--------------------: | :------------------------------------------: | :--------------------------------------------------------: |
> > > |   $\text{NumPasses}$   | $1 + \lceil \log_2 [\text{NPages(R)]}\rceil$ | $1 + \lceil \log_2 \text{7}\rceil=1 + \lceil 2.3\rceil=3 $ |
> > > | $\text{Total IO Cost}$ |        $\text{2Ã—NPages(R)Ã—NumPasses}$        |              $\text{2}\times{}7\times{}3=42$               |
> > >
> > > **3ï¸âƒ£**åŸºäºå¤–å½’å¹¶æ’åºçš„$\text{Projection}$å¼€é”€ï¼šç­‰äºä»¥ä¸‹æ¯åˆ—ä¹‹å’Œ(==è®°ä¸‹å³å¯==)
> > >
> > > | æ­¥éª¤ | æ“ä½œ                                             | $\textbf{Cost}$å€¼                 |
> > > | :--: | ------------------------------------------------ | :-------------------------------- |
> > > | è¯»å– | è¯»å–è¡¨($\text{Data File}$)ä¸­æ‰€æœ‰è¦æ’åºçš„é¡µåˆ°å†…å­˜ | $\text{NPages(R)}$                |
> > > | æŠ•å½± | æŠ•å½±ç­›æ‰ä¸€äº›é¡µï¼Œå°†æŠ•å½±åçš„é¡µå†™å›ç£ç›˜             | $\text{NPages(R)Ã—PF}$             |
> > > | æ’åº | å¯¹æŠ•å½±åçš„æ•°æ®æ’åº(æ¯è½®éƒ½è¦è¯»å†™ä¸€æ¬¡)             | $\text{NPages(R)Ã—PFÃ—2Ã—NumPasses}$ |
> > > | å†™å› | å°†æŠ•å½±+æ’åºåçš„é¡µï¼Œé‡æ–°è¯»å›å†…å­˜                  | $\text{NPages(R)Ã—PF}$             |
> >
> > ### $\textbf{2.2.3. External Hashing}$
> >
> > > **1ï¸âƒ£**åŸç†
> > >
> > > 1. ç¬¬ä¸€è½®ï¼šå†…å­˜æœ‰é™$\to{}1$é¡µç”¨ä½œç¼“å­˜$+$å‰©ä¸‹$\text{B-1}$é¡µå½“ä½œ$\text{Bucket}$â€‹
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/30913827511.png" alt="image-20240511073935359" style="zoom: 47%;" />  
> > >
> > >    - ç¡¬ç›˜çš„æ¯é¡µ$\xrightarrow[ç¼“å­˜]{è¯»å–}$å†…å­˜ä¸­çš„ç¼“å­˜é¡µ
> > >    - ç¼“å­˜é¡µçš„æ•°æ®$\xrightarrow[\text{Hash}]{\text{H1}}$å‰©ä¸‹çš„$\text{B-1}$ä¸ª$\text{Bucket}$â€‹ä¸­
> > >    - æ»¡äº†çš„$\text{Bucket}\xrightarrow{è¯»å‡º}$ç¡¬ç›˜ä¸­**è‹¥å¹²**é¡µ(ç”±äºä¸å¤Ÿç»†åˆ†ä¸€ä¸ª$\text{Bucket}$â€‹â€‹å¯èƒ½è¾“å‡ºå¤šé¡µ)
> > >    - æœ€ç»ˆç¡¬ç›˜ä¸­æœ‰$\text{Bucket1â†’Bucket(B-1)}$å…±$\text{B-1}$ä¸ª$\text{Bucket}$ï¼Œæ¯ä¸ª$\text{Bucket}$ä¸­æœ‰è‹¥å¹²é¡µ
> > >
> > > 2. ç¬¬äºŒè½®ï¼šè¯•å›¾ç”¨æœ‰é™å†…å­˜å……åˆ†åˆ†ç±»
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/13807891517.png" alt="13807891517" style="zoom:45%;" />  
> > >
> > >    - ç¡¬ç›˜$\text{Bucket1}$çš„æ¯é¡µ/$\text{Bucket2}$çš„æ¯é¡µ/..../$\text{Bucket(B-1)}$çš„æ¯é¡µ$\xrightarrow[ç¼“å­˜]{è¯»å–}$å†…å­˜ä¸­çš„ç¼“å­˜é¡µ
> > >    - ç¼“å­˜é¡µçš„æ•°æ®$\xrightarrow[\text{Hash}]{\text{H2(æ³¨æ„æ˜¯ä¸€ä¸ªæ–°çš„Hashå‡½æ•°)}}$æ–°çš„$\text{B-1}$ä¸ª$\text{Bucket}$â€‹ä¸­
> > >    - ä»¥æ­¤ç±»æ¨.............
> > >
> > > 3. æœ€åä¸€è½®ï¼šæ‰€æœ‰çš„æ•°æ®å¾—åˆ°äº†å……åˆ†çš„ç»†åˆ†ï¼Œä»¥è‡³äºæœ€åæ¯ä¸ª$\text{Bucket}$â€‹ä¸­åªåŒ…å«ä¸€ä¸ªæ•°æ®
> > >
> > > **2ï¸âƒ£**åŸºäº$\text{External Hashing}$çš„$\text{Projection}$å¼€é”€
> > >
> > > | æ­¥éª¤ | æ“ä½œ                                             | $\textbf{Cost}$å€¼     |
> > > | :--: | ------------------------------------------------ | :-------------------- |
> > > | è¯»å– | è¯»å–è¡¨($\text{Data File}$)ä¸­æ‰€æœ‰è¦æ’åºçš„é¡µåˆ°å†…å­˜ | $\text{NPages(R)}$    |
> > > | æŠ•å½± | æŠ•å½±ç­›æ‰ä¸€äº›é¡µï¼Œå°†æŠ•å½±åçš„é¡µå†™å›ç£ç›˜             | $\text{NPages(R)Ã—PF}$ |
> > > | å†™å› | å°†æŠ•å½±åçš„é¡µï¼Œé‡æ–°è¯»å›å†…å­˜                       | $\text{NPages(R)Ã—PF}$ |
>
> ## $\textbf{2.3. Join Algorithms}$ 
>
> > ### $\textbf{2.3.1. Nested Loops Join}$
> >
> > > **0ï¸âƒ£**å…³äº$\text{Inner/Outer Table}$â€‹
> > >
> > > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240511093730591.png" alt="image-20240511093730591" style="zoom:59%;" />  
> > >
> > > 1. å¦‚æœå¯ä»¥é€‰$\text{â†’}$ä¸€èˆ¬è®¾å®š$\text{Outer}$ä¸º$\text{NPages}$â€‹è¾ƒå°çš„è¡¨
> > > 2. é»˜è®¤å·¦è¾¹æ˜¯$\text{Outer}$å³è¾¹æ˜¯$\text{Inner}$
> > >
> > > **1ï¸âƒ£**åŸç†
> > >
> > > |    $\textbf{Type}$     | $\textbf{Outer Table}$çš„æ¯___ | $\xrightarrow{æ‰«æ}$ | $\textbf{Inner Table}$çš„æ¯___ |
> > > | :--------------------: | :---------------------------: | :------------------: | :---------------------------: |
> > > |    $\text{Simple}$     |              è¡Œ               | $\xrightarrow{æ‰«æ}$ |              é¡µ               |
> > > | $\text{Page-Oriented}$ |              é¡µ               | $\xrightarrow{æ‰«æ}$ |              é¡µ               |
> > > |     $\text{Block}$     |        å—(åŒ…å«å¤šä¸ªé¡µ)         | $\xrightarrow{æ‰«æ}$ |              é¡µ               |
> > >
> > > **2ï¸âƒ£**ç¤ºæ„å›¾ä¸å·¥ä½œæµç¨‹
> > >
> > > 1. $\text{Simple Nested Loops Join}$â€‹
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240511123035510.png" alt="image-20240511123035510" style="zoom: 26.5%;" />  
> > >
> > >    |      $\textbf{Outer Page}$      | $\textbf{Inner Page}$ |
> > >    | :-----------------------------: | :-------------------: |
> > >    | $\text{Outer Page 1, Tuple 1}$  | $\text{Inner Page 1}$ |
> > >    | $\text{Outer Page 1, Tuple 1}$  | $\text{Inner Page 2}$ |
> > >    | $\text{Outer Page 1, Tuple 1}$  | $\text{Inner Page 3}$ |
> > >    | $\text{Outer Page 1, Tuple 1}$  | $\text{Inner Page 4}$ |
> > >    | $\text{Outer Page 1, Tuple 2}$  | $\text{Inner Page 1}$ |
> > >    |              .....              |         .....         |
> > >    | $\text{Outer Page 10, Tuple N}$ | $\text{Inner Page 4}$ |
> > >
> > > 2. $\text{Page-Oriented Nested Loops Join: }$å†…å­˜ä¸å¤šä¸å°‘ï¼Œå°±å ç”¨ä¸‰é¡µ
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240511101634537.png" alt="image-20240511101634537" style="zoom:50%;" />  
> > >
> > >    | $\textbf{Outer Page}$  | $\textbf{Inner Page}$ |
> > >    | :--------------------: | :-------------------: |
> > >    | $\text{Outer Page 1}$  | $\text{Inner Page 1}$ |
> > >    | $\text{Outer Page 1}$  | $\text{Inner Page 2}$ |
> > >    | $\text{Outer Page 1}$  | $\text{Inner Page 3}$ |
> > >    | $\text{Outer Page 1}$  | $\text{Inner Page 4}$ |
> > >    | $\text{Outer Page 2}$  | $\text{Inner Page 1}$ |
> > >    |         .....          |         .....         |
> > >    | $\text{Outer Page 10}$ | $\text{Inner Page 4}$ |
> > >
> > > 3. $\text{Block Nested Loops Join}$   
> > >
> > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240513080234516.png" alt="image-20240513080234516" style="zoom:33%;" /> 
> > >
> > >    |             $\textbf{Outer Page}$             | $\textbf{Inner Page}$ |
> > >    | :-------------------------------------------: | :-------------------: |
> > >    | $\text{Outer Page 1 + Outer Page 2(Block1)}$  | $\text{Inner Page 1}$ |
> > >    | $\text{Outer Page 1 + Outer Page 2(Block1)}$  | $\text{Inner Page 2}$ |
> > >    | $\text{Outer Page 1 + Outer Page 2(Block1)}$  | $\text{Inner Page 3}$ |
> > >    | $\text{Outer Page 1 + Outer Page 2(Block1)}$  | $\text{Inner Page 4}$ |
> > >    | $\text{Outer Page 3 + Outer Page 4(Block2)}$  | $\text{Inner Page 1}$ |
> > >    |                     .....                     |         .....         |
> > >    | $\text{Outer Page 9 + Outer Page 10(Block5)}$ | $\text{Inner Page 4}$ |
> > >
> > > **3ï¸âƒ£**å¼€é”€ï¼šå¤–è¡¨æ‰«ææˆæœ¬$+$å†…è¡¨æ‰«ææˆæœ¬
> > >
> > > |    $\textbf{Type}$     |      å¤–è¡¨æ‰«ææˆæœ¬      |                    å†…è¡¨æ‰«ææˆæœ¬                     |
> > > | :--------------------: | :--------------------: | :-------------------------------------------------: |
> > > |    $\text{Simple}$     | $\text{NPages(Outer)}$ | $\text{NTuples(Outer)}\text{Ã—}\text{NPages(Inner)}$ |
> > > | $\text{Page-Oriented}$ | $\text{NPages(Outer)}$ | $\text{NPagees(Outer)}\text{Ã—}\text{NPages(Inner)}$ |
> > > |     $\text{Block}$     | $\text{NPages(Outer)}$ | $\text{NBlocks(Outer)}\text{Ã—}\text{NPages(Inner)}$ |
> > >
> > > 1. å¤–è¡¨æ‰€æœ‰é¡µéƒ½è¦è¢«è¯»ä¸€æ¬¡ï¼Œæ‰€ä»¥æˆæœ¬ä¸º$\text{NPages(Outer)}$ 
> > > 2. $\text{NBlocks(Outer)=NPages(Outer)/(Memory-2)}$
> > >    - $\text{Memory-2}$ä¸º$\text{RAM}$ä¸­$\text{Outer Pages}$çš„æ•°é‡ï¼Œå³ä¸€æ¬¡ä»$\text{Outer Table}$â€‹è¯»å…¥å¤šå°‘é¡µ
> > >    - å½“$\text{NBlocks(Outer)}$â€‹â€‹â€‹â€‹â€‹ä¸ä¸ºæ•´æ•°æ—¶ï¼Œè¦==å‘ä¸Šå–æ•´== 
> > >    - åˆ†é…$\text{RAM(Memory)}$è¶Šå¤šï¼Œå°±ä¼š$\text{NBlocks(Outer)}$è¶Šä½ï¼Œä»è€Œå¼€é”€è¶Šå°
> > >
> > > **4ï¸âƒ£**å¼€é”€çš„æœ€ä¼˜è§£ï¼š$\begin{cases}\text{RAM}å¯æŠŠ\text{Outer Table}å…¨æ”¾è¿›\to{}å¤§å°è‡³å°‘ä¸º\text{NPages(Outer)+2}\\\\æœ€ä¼˜è§£\to{}\text{Cost=NPages(Outer)+NPages(Inner)}\end{cases}$
> > >
> > > 1. è¿™å…¶å®ä¸ä»…æ˜¯$\text{NLJ}$çš„æœ€ä¼˜è§£ï¼Œ==ä¹Ÿæ˜¯å…¨å±€æœ€ä¼˜è§£ï¼Œå› ä¸ºè¿™ä¸ªè§£åˆšåˆšåˆšå¥½æ˜¯æŠŠä¸¤ä¸ªè¡¨è¯»è¿›æ¥== 
> > >
> > > 2. åœ¨æœ€ä¼˜è§£ä¸å˜çš„æƒ…å†µä¸‹ä¸ºäº†èŠ‚çœå†…å­˜$\to{}$==$\text{Outer}$è¡¨è¦å°½é‡å°(å°è¡¨)== 
> >
> > ### $\textbf{2.3.2. Sort-Merge Join}$ 
> >
> > > **1ï¸âƒ£**åŸç†ï¼šä»¥`A INNER JOIN B ON A.age = B.number`ä¸ºä¾‹
> > >
> > > 1. ç¬¬ä¸€æ­¥ï¼šæŒ‰ç…§$\text{Join Column}$(æ­¤å¤„åˆ†åˆ«ä¸º`age`å’Œ`number`)æ’åº
> > >    - $\text{A}$è¡¨æŒ‰ç…§`age`æ’åºï¼Œ$\text{B}$â€‹â€‹è¡¨æŒ‰ç…§`numver`æ’åº
> > >    - ç›®çš„åœ¨äºï¼š==è®©ç›¸åŒ/ç›¸å…³çš„å€¼ç‰©ç†ä¸Šé è¿‘ï¼Œå¯ä»¥é¡ºåºè®¿é—®$\text{â†’}$â€‹åŠ å¿«åˆå¹¶==
> > > 2. ç¬¬äºŒæ­¥ï¼š$\text{AB}$ä¸¤è¡¨å†è¿›è¡Œ$\text{Join}$â€‹æ“ä½œ
> > > 3. $\text{Output}$: ä¸€å®šæ˜¯æŒ‰ç…§$\text{Join Column}$æ’å¥½åºçš„
> > >
> > > **2ï¸âƒ£**æ’åºçš„æˆæœ¬ä¸º$\text{0}$çš„æƒ…å†µï¼š==$\text{Clustered + }$$\text{B}^{+}\text{Tree + }$$\text{Join Column}$æ˜¯ç´¢å¼•ä¾æ®çš„$\text{Prefix}$== â€‹
> > >
> > > ```sql
> > > A INNER JOIN B ON A.age = B.number
> > > ```
> > >
> > > | ç´¢å¼•æ ¹æ®($\textbf{Composite Search Key}$) |          ç´¢å¼•ç±»å‹          | è¡¨$\textbf{A}$æ— éœ€æ’åº |
> > > | ----------------------------------------- | :------------------------: | :--------------------: |
> > > | `<A.age>`                                 | $\text{Clustered B}^{+}$æ ‘ |           âœ”ï¸            |
> > > | `<A.name>`                                | $\text{Clustered B}^{+}$æ ‘ |           âŒ            |
> > > | `<A.age, A.name>`                         | $\text{Clustered B}^{+}$æ ‘ |           âœ”ï¸            |
> > > | `<A.name, A.age>`                         | $\text{Clustered B}^{+}$æ ‘ |           âŒ            |
> > >
> > > **3ï¸âƒ£**$\text{Cost = Sort(Outer)+ Sort(Inner)+ NPages(Outer)+ NPages(Inner)}$ 
> > >
> > > |    $\textbf{Cost}$     |              æˆå›               |
> > > | :--------------------: | :----------------------------: |
> > > |  $\text{Sort(Outer)}$  |       å°†å¤–è¡¨æ‰€æœ‰å…ƒç´ æ’åº       |
> > > |  $\text{Sort(Inner)}$  |       å°†å†…è¡¨æ‰€æœ‰å…ƒç´ æ’åº       |
> > > | $\text{NPages(Outer)}$ | éå†å¤–è¡¨çš„æ‰€æœ‰é¡µä»¥æ‰§è¡Œåˆå¹¶æ“ä½œ |
> > > | $\text{NPages(Inner)}$ | éå†å†…è¡¨çš„æ‰€æœ‰é¡µä»¥æ‰§è¡Œåˆå¹¶æ“ä½œ |
> > >
> > > - $\text{Sort(X)=}\begin{cases} \text{2Ã—NumPassesÃ—NPages(X)}\\\\0\text{ (Clustered B}^{+}\text{ Index on Join Column Prefix)}\end{cases}$ 
> >
> > ### $\textbf{2.3.3. Hash Join}$(ä¸€èˆ¬æƒ…å†µå¼€é”€æœ€å°)
> >
> > > **1ï¸âƒ£**åŸç†ï¼šä»¥æŒ‰ç…§`A.id = B.id`$\text{Join}$ä¸ºä¾‹ï¼Œå…¶ä¸­`id`ä¸ºè¿æ¥é”®
> > >
> > > 1. $\text{Build Phase}$: `A.id`$\xrightarrow[\text{Hash}]{\text{H1å“ˆå¸Œå‡½æ•°}}$â€‹`H1(A.id)`æ„å»º$\text{Hash}$è¡¨$\text{A}$ï¼Œ==é€šå¸¸æ˜¯é€‰å°è¡¨($\text{Inner}$)æ¥æ„å»º$\text{Hash}$è¡¨==
> > > 2. $\text{Probe Phase}$(æ¢æµ‹é˜¶æ®µ):  
> > >    - `B.id`$\xrightarrow[\text{Hash}]{\text{H1å“ˆå¸Œå‡½æ•°}}$`H1(B.id)`å¾—åˆ°$\text{Hash}$å€¼$\text{B(n)}$ 
> > >    - åœ¨$\text{Hash}$è¡¨$\text{A}$ä¸­æ£€ç´¢$\text{Hash}$â€‹å€¼$\text{B(n)}$åˆ™åŒ¹é…ï¼Œé‚£ä¹ˆåŒ¹é…çš„è¡Œè¿›è¡Œ$\text{Join}$
> > >
> > > **2ï¸âƒ£**$\text{Cost=3Ã—NPages(Outer)+3Ã—NPages(Inner)}$â€‹â€‹â€‹ â€‹
> >
> > ### $\textbf{2.3.4. Join Pipeline}$ï¼šå‡å°‘$\textbf{Cost}$çš„ä¸€ç§æ–¹å¼
> >
> > > #### $\textbf{2.3.4.1. }$åŸºæœ¬æ¦‚å¿µ
> > >
> > > > **1ï¸âƒ£**$\text{Left-Deep Join Tree}$â€‹ï¼š
> > > >
> > > > 0. å¤šé‡$\text{Join: }$è€ƒè™‘$\text{Join}$çš„é¡ºåºå’Œç±»å‹
> > > >
> > > > 1. $\text{Left-Deep Join Tree: }$æ˜¯æœ€ä¼˜$\text{Join}$é¡ºåº(å¿«é€Ÿå¢é•¿ç‡)ï¼Œæ–¹ä¾¿åœ¨$\text{RAM}$ä¸­$\text{Pipeline}$å¹¶è¡Œå¤„ç†
> > > >
> > > > 2. ç¤ºæ„å›¾ï¼šé»˜è®¤å·¦è¾¹çš„ä¸º$\text{Outer Table}$
> > > >
> > > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240512191103986.png" alt="image-20240512191103986" style="zoom: 43%;" />  
> > > >
> > > > **2ï¸âƒ£**$\text{Pipeline}$
> > > >
> > > > 1. æ¦‚å¿µï¼š
> > > >
> > > >    - $\text{Direct â€œstreamingâ€ in memory}$
> > > >    - $\text{Of the output of one operation as the input of another operation}$
> > > >    - $\text{Without writing output to disk}$
> > > >
> > > > 2. åŸºäº$\text{Left-Deep Join Tree}$çš„$\text{Pipeline}$â€‹â€‹ç¤ºä¾‹
> > > >
> > > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240513002106358.png" alt="image-20240513002106358" style="zoom: 67%;" /> 
> > > >
> > > >    | $\textbf{Stage}$ |            $\textbf{Outer Page}$             | $\textbf{Inner Page}$ | $\textbf{Output Page}$                                       |
> > > >    | :--------------: | :------------------------------------------: | :-------------------: | :----------------------------------------------------------- |
> > > >    |    $\text{1}$    |                  $\text{A}$                  |      $\text{B}$       | $\text{A}\bowtie{}\text{B}\xrightarrow{\text{Move to}}\text{Outer Page}$ |
> > > >    |    $\text{2}$    |         $\text{A}\bowtie{}\text{B}$          |      $\text{C}$       | $\text{A}\bowtie{}\text{B}\bowtie{}\text{C}\xrightarrow{\text{Move to}}\text{Outer Page}$ |
> > > >    |    $\text{3}$    | $\text{A}\bowtie{}\text{B}\bowtie{}\text{C}$ |      $\text{D}$       | $\text{A}\bowtie{}\text{B}\bowtie{}\text{C}\bowtie{}\text{D}\xrightarrow{\text{Finally}}\text{Output}$ |
> > >
> > > #### $\textbf{2.3.4.2. Pipeline}$ç®€åŒ–è®¡ç®— 
> > >
> > > > **1ï¸âƒ£**ç®€åŒ–è®¡ç®—$\text{1}$ï¼š$\text{Heap Scan}$ä¸ç®—$\text{Cost + }$ä¸Šå±‚$\text{Join}$ä¹Ÿä¸å‡å…¶$\text{Pipelining}$
> > > >
> > > > 1. åŸå› ï¼š$\text{Heap Scan}$æ‰«æçš„æˆæœ¬ï¼Œå’Œå…¶å¯¹åº”å‡å»çš„$\text{Pipelining}$ï¼Œéƒ½ç­‰äºå¯¹åº”è¡¨å¤§å°ï¼Œäº’ç›¸æŠµæ¶ˆ
> > > >
> > > > 2. ç¤ºä¾‹$\text{1: Join}$(é¡¶å±‚)å¼€é”€$\text{=NLJ}$å¼€é”€
> > > >
> > > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/49521839130.png" alt="49521839130" style="zoom:30%;" /> 
> > > >
> > > >    - åŸæœ¬å¼€é”€ï¼š$\text{NLJ+}$ä¸¤ä¸ª$\text{Heap Scan}$â€‹ 
> > > >    - $\text{Pipeline: }$å‡å»ä¸¤ä¸ª$\text{Heap Scan}$ 
> > > >
> > > > 3. ç¤ºä¾‹$\text{2: Join}$(é¡¶å±‚)å¼€é”€$\text{=SMJ}$å¼€é”€$-\text{RSA(Result Size A)}$ï¼Œ==æ³¨æ„$\text{RSA}$æ˜¯ä»¥$\text{Pages}$ä¸ºå•ä½==
> > > >
> > > >    <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/77537735808.png" alt="77537735808" style="zoom:30%;" />  
> > > >
> > > >    - åŸæœ¬å¼€é”€ï¼š$\text{SMJ+}\text{Heap Scan}$ 
> > > >    - $\text{Pipeline: }$å‡å»$\text{Heap Scan}$ï¼Œå‡å»$\text{RSA}$ 
> > > >
> > > > **2ï¸âƒ£**ç®€åŒ–è®¡ç®—$\text{2: Heap Scan}$è‡ªåŠ¨å¿½ç•¥æ‰€æœ‰$\text{Index}$â€‹ï¼Œæ¥çœ‹ä¸€ä¸ªä¸å¿½ç•¥$\text{Index}$çš„ç¤ºä¾‹
> > > >
> > > > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240617140212192.png" alt=" " style="zoom: 25%;" /> 
> > > >
> > > > 1. åŸæœ¬å¼€é”€ï¼š$\text{HJ}$å¼€é”€$\text{+Index Scan(Test)}$å¼€é”€ (å…·ä½“æ€ä¹ˆç®—è¦çœ‹é‡‡ç”¨å“ªç§$\text{Index}$ )
> > > >
> > > > 2. $\text{Pipeline: }$å‡å»$\text{NPages(Test)}$ï¼Œå‡å»$\text{RSA}$ 
> > >

# $\textbf{3. Query Optimization}$

> ## $\textbf{3.1. Relational Algebra Equivalences}$
>
> > ### $\textbf{3.1.1. Selection/Projection Equivalences}$
> >
> > > **1ï¸âƒ£**æ¦‚è§ˆ
> > >
> > > |               å®šå¾‹                |                             å…¬å¼                             |          å«ä¹‰           |
> > > | :-------------------------------: | :----------------------------------------------------------: | :---------------------: |
> > > | $\small\text{Selection Cascade}$  | $\sigma_{\text{c}_1 \wedge \cdots \wedge \text{c}_\text{n}}(\text{R})\equiv \sigma_{\text{c}_1}\left(\ldots\left(\sigma_{\text{c}_\text{n}}(\text{R})\right)\right)$ | å¤šæ¡ä»¶ç­›è¡Œ$=$æ¯ä¸ªéƒ½ç­›ä¸‹ |
> > > | $\small\text{Selection Commute}$  | $\sigma_{\text{c}_\text{1}}\left(\sigma_{\text{c}_2}(\text{R})\right)\equiv \sigma_{\text{c}_2}\left(\sigma_{\text{c}_\text{1}}(\text{R})\right)\equiv{}\sigma_{\text{c}_\text{1} \wedge \text{c}_\text{2}}(\text{R})$ | å…ˆç”¨å“ªä¸ªæ¡ä»¶ç­›é€‰æ— æ‰€è°“  |
> > > | $\small\text{Projection Cascade}$ | $\pi_{\text{a}_\text{1}}(R) \equiv \pi_{\text{a}_\text{1}}\left(\ldots\left(\pi_{\text{a}_n}(R)\right)\right)$ | éšä¾¿æŠ•ï¼Œæœ€åä¸€ä¸‹è¯´äº†ç®—  |
> > >
> > > âš ï¸æ³¨æ„äº‹é¡¹ï¼š$\text{Projection Cascade}$ä¸­ï¼Œå‡è®¾$\text{A}$æ˜¯$\text{Attributes}$çš„é›†åˆ$\left(\text{A=}\{\text{a}_\text{1},\text{a}_2,...,\text{a}_\text{n}\}\right)$
> > >
> > > 1. åœ¨$\pi{_{\text{A}_\text{1}}}(\ldots(\pi{_{\text{A}}}_\text{n}(\text{R})))$ä¸­ï¼Œå¿…é¡»æ»¡è¶³$\text{A}_{\text{n}}\subseteq{}\text{A}_{\text{m}}(\text{n<m})$
> > >
> > > 2. ä»¥$\pi{_{\text{A}_\text{1}}}(\pi{_{\text{A}}}_\text{2}(\text{R}))$ä¸ºä¾‹
> > >
> > >    |     ${\textbf{A}_\textbf{1}}$      |                  ${\textbf{A}_\textbf{2}}$                   |            æ˜¯å¦é€‚ç”¨$\textbf{Projection Cascade}$             |
> > >    | :--------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
> > >    | $\{\text{a}_\text{1},\text{a}_2\}$ |              $\{\text{a}_\text{1},\text{a}_2\}$              | $\text{A}_{\text{1}}\subseteq{}\text{A}_{\text{2}}\to{}\pi{_{\text{a}_\text{1},\text{a}_\text{2}}}(\pi{_{\text{a}_\text{1},\text{a}_\text{2}}}(\text{R}))=\pi{_{\text{a}_\text{1},\text{a}_\text{2}}}(\text{R})$ |
> > >    | $\{\text{a}_\text{1},\text{a}_2\}$ | $\{\text{a}_\text{1},\text{a}_2,\text{a}_\text{3},\text{a}_4\}$ | $\text{A}_{\text{1}}\subseteq{}\text{A}_{\text{2}}\to{}\pi{_{\text{a}_\text{1},\text{a}_\text{2}}}(\pi{_{\text{a}_\text{1},\text{a}_\text{2},\text{a}_\text{3},\text{a}_\text{4}}}(\text{R}))=\pi{_{\text{a}_\text{1},\text{a}_\text{2}}}(\text{R})$ |
> > >    | $\{\text{a}_\text{1},\text{a}_4\}$ |     $\{\text{a}_\text{1},\text{a}_2,\text{a}_\text{3}\}$     | $\text{A}_{\text{1}} \not\subseteq{}\text{A}_{\text{2}}$ä¸é€‚ç”¨ |
> > >
> > > **2ï¸âƒ£**ç¤ºä¾‹ï¼šå…³äºç¬¬$\text{3}$ä¸ªï¼Œæ³¨æ„è¦è®©==å¤–éƒ¨æ“ä½œ($\pi{}\text{/}\sigma$)çš„$\text{Column}\subseteq$ é‡Œé¢æ“ä½œ($\pi$)çš„$\text{Column}$==  
> > >
> > > 1. $\large{}\sigma_{\text{age<18 }\wedge \text{ rating}>5}\text{(Sailors)}\Leftrightarrow\begin{cases} \sigma_{\text{age}<18}\left(\sigma_{\text{rating}>5}\text{(Sailors)}\right)\\\\ \left.\sigma_{\text{rating}>5}\left(\sigma_{\text{age}<18}\text{(Sailors}\right)\right)\end{cases}$ 
> > >
> > >    
> > > 
> > > 2. $\large\pi_{\text{age,rating}}(\text{Sailors})\Leftrightarrow \pi_{\text{age,rating}}\left(\pi_{\text{age,rating,sid}}\text{(Sailors)}\right)$ â€‹
> > >
> > >    
> > >
> > > 3. $\large\begin{cases}\begin{flalign*}& \pi_{\text{age,sid}}( \sigma_{\text{age<18 }\wedge \text{ rating}>5}\text{(Sailors))} &\\& \Updownarrow &\\& \begin{cases}\text{é”™è¯¯çš„: }\sigma_{\text{age<18 } \wedge \text{ rating}>5}\left(\pi_{\text{age, sid}}(\text{Sailors})\right)\\\\\text{æ­£ç¡®çš„: }\sigma_{\text{age<18 } \wedge \text{ rating}>5}\left(\pi_{\text{age, sid, rating}}(\text{Sailors})\right)\end{cases}&\\\end{flalign*}\end{cases}$ â€‹
> > 
> > ### $\textbf{3.1.2. Join Equivalences}$
> > 
> > > |           å®šå¾‹            |                             å…¬å¼                             |               å«ä¹‰                |
> >> | :-----------------------: | :----------------------------------------------------------: | :-------------------------------: |
> > > | $\text{Join Associative}$ | $\text{R}\bowtie(\text{S} \bowtie \text{T})\equiv(\text{R}\bowtie \text{S})\bowtie \text{T} \quad$ | $\text{Join}$é¡ºåºä¸å½±å“ç»“æœ(ä¸‰ä¸ª) |
> >> | $\text{Join Commutative}$ | $(\text{R}\bowtie \text{S})\equiv(\text{S}\bowtie \text{R})\quad$ | $\text{Join}$é¡ºåºä¸å½±å“ç»“æœ(ä¸¤ä¸ª) |
> > 
> 
> ## $\text{3.2. }$$\textbf{Query Optimization}$å®ä¾‹
> 
> > **1ï¸âƒ£**$\text{Cross Product}$ä¼˜åŒ–ï¼šè½¬åŒ–ä¸ºæœ‰æ¡ä»¶çš„$\text{Join}$
>>
> > $\large{}\begin{flalign*}& \sigma_{\text{Sailors.sid=Reserves.sid}}(\text{Sailors} \text{Ã—}\text{Reserves}) &\\& \Updownarrow &\\& \text{Sailors} \bowtie_{\text{Sailors.sid=Reserves.sid}} \text{Reserves} &\\& \Updownarrow &\\& \text{Sailors} \bowtie \text{Reserves }\end{flalign*}$ 
>>
> > **2ï¸âƒ£**$\text{Predicate Pushdown: }$å…ˆç»™è¡¨æ ¼$\sigma{}$ç­›é€‰$\to{}$é™ä½æ•°æ®é‡/å‡å°‘è®¡ç®—
> >
> > $\large{}\begin{flalign*}
> > & \sigma_{\text{Sailors.age<18}}(\text{Sailors} \bowtie_{\text{Sailors.sid=Reserves.sid}} \text{Reserves}) &\\
> > & \Bigg\Updownarrow {\small{æƒ³åŠæ³•æŠŠ\text{Join}å·¦è¾¹çš„\text{Sailors}è¡¨æ ¼å˜å°}} &\\
> > &(\sigma_{\text{Sailors.age<18}}(\text{Sailors})) \bowtie_{\text{Sailors.sid=Reserves.sid}} \text{Reserves} &
> > \end{flalign*}$ 
> >
> > **3ï¸âƒ£**$\text{Projection Pushdown: }$å…ˆç»™è¡¨æ ¼$\pi{}$ç­›é€‰$\to{}$é™ä½æ•°æ®é‡/å‡å°‘è®¡ç®—
> >
> > $\large{}\begin{flalign*}
> > & \pi_{\text{Sailors.sname}}(\text{Sailors} \bowtie_{\text{Sailors.sid=Reserves.sid}} 
> > \text{Reserves})&\\
> > & \Bigg\Updownarrow {\small{æƒ³åŠæ³•æŠŠ\text{Join}å·¦å³çš„\text{Sailors/Reserves}è¡¨æ ¼å˜å°}\to{}\text{æŠŠä¸¤å¼ è¡¨ä¸­ç”¨å¾—åˆ°çš„Columnéƒ½Projectå‡ºæ¥}} &\\
> > &\pi_{\text{Sailors.sname}}(\pi_{\text{sname, sid}}
> > (\text{Sailors}) \bowtie_{\text{Sailors.sid=Reserves.sid}} \pi_{\text{sid}}(\text{Reserves})) &
> > \end{flalign*}$â€‹ 

# $\textbf{4. Query Cost}$è®¡ç®—é¢˜

> ## $\textbf{4.1. Of One Table}$
>
> > **1ï¸âƒ£**åŸç†ï¼šè€ƒè™‘å„ç§å¯èƒ½çš„$\text{Query}$é€”å¾„($\text{Scan/Index}$)$\to{}$é€‰æ‹©å¼€é”€æœ€å°çš„ä¸€ä¸ª
> >
> > 1. æ³¨æ„æ°¸è¿œåˆ«å¿˜äº†ç®—ä¸€ä¸‹$\text{Heap Scan}$ï¼Œæœ‰æ—¶å€™ç®—æ¥ç®—å»åå€’$\text{Heap Scan}$â€‹â€‹å¼€é”€æœ€å°
> > 2. é™¤å»$\text{Heap Scan}$å…¶å®ƒæ‰€æœ‰ç±»å‹çš„å¼€é”€ï¼Œéƒ½éœ€è¦å…ˆä¼°è®¡$\text{RF }\downarrow{}$â€‹
> >
> > **2ï¸âƒ£**$\text{RF}$ä¼°ç®—æ±‡æ€»
> >
> > |         æ¡ä»¶         |                       $\text{RF}$ç­‰äº                        |               è¡¥å……è¯´æ˜               |
> > | :------------------: | :----------------------------------------------------------: | :----------------------------------: |
> > | ${}\text{Col=Value}$ |           $\cfrac{\text{Num}}{\text{NKeys(Col)}}$            |           ==å¤„ç†ç¦»æ•£å˜é‡==           |
> > |  $\text{Col>Value}$  | $\cfrac{\text{High(Col)}-\text{Value}}{\text{High(Col)}-\text{Low(Col)}}$ |           ==å˜é‡å¿…é¡»è¿ç»­==           |
> > |  $\text{Col<Value}$  | $\cfrac{\text{Value}-\text{Low(Col)}}{\text{High(Col)}-\text{Low(Col)}}$ |           ==å˜é‡å¿…é¡»è¿ç»­==           |
> > |  $\text{Join}$æ“ä½œ   |    $\cfrac{1}{\text{Max[NKeys(Col\_A), NKeys(Col\_B)]}}$     | ä¸»é”®æ‰€åœ¨åˆ—$\text{JoinCol}$å”¯ä¸€å€¼æ›´å¤š |
> > |    æ— ä»»ä½•å·²çŸ¥æ¡ä»¶    |                  $\text{RF=}\cfrac{1}{10}$                   |                 é»˜è®¤                 |
> >
> > **3ï¸âƒ£**åŸºäº`WHERE + Condition`çš„$\text{RF}$â€‹â€‹â€‹é€‰å–
> >
> > ```sql
> > WHERE day<8/9/94 AND bid=5 AND sid=3
> > ```
> >
> > |      $\textbf{Type}$      | $\textbf{Index}$ | $åŒ¹é…çš„\textbf{Prefix}$ |      æ˜¯å¦é€‚ç”¨äºç¤ºä¾‹çš„æŸ¥è¯¢       |      $\textbf{RF}$       |
> > | :-----------------------: | :--------------: | :---------------------: | :-----------------------------: | :----------------------: |
> > | $\text{B}^{+}\text{Tree}$ |  `<rname,day>`   |      $\text{N/A}$       | $\text{N}(æ— åŒ¹é…\text{Prefix})$ |        $\text{1}$        |
> > | $\text{B}^{+}\text{Tree}$ |  `<day,rname>`   |          `day`          |           $\text{Y}$            |     $\text{RF(day)}$     |
> > | $\text{B}^{+}\text{Tree}$ |   `<day,sid>`    |        `day,sid`        |           $\text{Y}$            | $\text{RF(day)*RF(sid)}$ |
> > |       $\text{Hash}$       |  `<day,rname>`   |          `day`          |  $\text{N(Hashä¸èƒ½èŒƒå›´æœç´¢)}$   |        $\text{1}$        |
> >
> > 1. ç´¢å¼•åŒ¹é…çš„è°“è¯ï¼š`WHERE + Condition`==å¿…é¡»è¦==åŒ…å«$\text{Composite Search Key}$çš„$\text{Prefix}$
> > 2. $\text{Hash}$ä¸èƒ½ä½œ$\text{Range Search}$
> >
> > **4ï¸âƒ£**åŸºäº$\text{RF}$çš„$\text{Scan Cost Formula}$æ±‡æ€»
> >
> > | $\textbf{Structure}$ |     $\textbf{Index}$å®ç°      | $\textbf{Index}$å­˜å‚¨/è§’è‰² |                             å¼€é”€                             |
> > | :------------------: | :---------------------------: | :-----------------------: | :----------------------------------------------------------: |
> > |  $\text{Heap File}$  |         $\text{N/A}$          |       $\text{N/A}$        |                      $\text{NPages(R)}$                      |
> > | $\text{Sorted File}$ |         $\text{N/A}$          |       $\text{N/A}$        |       $\log_{2}\text{[NPages(R)]+RFÃ—}\text{NPages(R)}$       |
> > | $\text{index File}$  |   $\text{B}^{+}\text{Tree}$   |     $\text{Primary}$      |                 $\text{æ ‘é«˜Height(Index)+1}$                 |
> > | $\text{index File}$  |         $\text{Hash}$         |     $\text{Primary}$      |     $\text{ProbeCost(Index)+1}\xrightarrow{é»˜è®¤ä¸º}1.2+1$     |
> > | $\text{index File}$  |   $\text{B}^{+}\text{Tree}$   | ==$\text{Unclustered}$==  | $\text{[NPages(I)+NTuples(R)]Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}$ |
> > | $\text{index File}$  | ==$\text{B}^{+}\text{Tree}$== |  ==$\text{Clustered}$==   | $\text{[NPages(I)+NPages(R)]Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}$ |
> > | $\text{index File}$  |         $\text{Hash}$         | ==$\text{Unclustered}$==  | $\text{NTuples(R)Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}\times{}2.2$ |
> > | $\text{index File}$  |         $\text{Hash}$         |  ==$\text{Clustered}$==   | $\text{NPages(R)Ã—}\prod_\limits{i=1\ldots\text{n}}\text{RF}_{\text{i}}\times{}2.2$ |
> >
>
> ## $\textbf{4.2. Of Multiple Tables}$ 
>
> > **1ï¸âƒ£**éœ€è¦è€ƒè™‘çš„é—®é¢˜
> >
> > |            äº‹é¡¹             | æ³¨é‡Š                                                         |
> > | :-------------------------: | ------------------------------------------------------------ |
> > | $\text{Join}$æ‰€æœ‰å¯èƒ½çš„é¡ºåº | è¿™ä¸ä¼šå½±å“$\text{Join}$ç»“æœä½†ä¼šå½±å“å¼€é”€ï¼Œä¸€èˆ¬åªè€ƒè™‘$\text{Left-Deep Join Tree}$ |
> > | $\text{Join}$æ‰€æœ‰å¯èƒ½çš„ç®—æ³• | ä½†æ˜¯æ’é™¤æœ€è ¢çš„$\text{Cross Product}$                         |
> >
> > **2ï¸âƒ£**å¯¹$\text{Pipeline}$â€‹çš„å¤„ç†
> >
> > 1. $\text{Heap Scan}$ä¸ç®—$\text{Cost + }$ä¸Šå±‚$\text{Join}$ä¹Ÿä¸å‡å…¶$\text{Pipelining}$â€‹
> > 2. $\text{Heap Scan}$è‡ªåŠ¨å¿½ç•¥æ‰€æœ‰$\text{Index}$
> >
> > **3ï¸âƒ£**$\text{Join Cost}$æ±‡æ€»ï¼šæ³¨æ„å°è¡¨ä¸º$\text{Outer}$
> >
> > |       $\textbf{Type}$       | æ‰«ææˆæœ¬                                                     |
> > | :-------------------------: | :----------------------------------------------------------- |
> > |     $\text{Simple NLJ}$     | $\text{NPages(Outer)+}\text{NTuples(Outer)}\text{Ã—}\text{NPages(Inner)}$ |
> > | $\text{Page-Oriented  NLJ}$ | $\text{NPages(Outer)+}\text{NPagees(Outer)}\text{Ã—}\text{NPages(Inner)}$ |
> > |     $\text{Block  NLJ}$     | $\text{NPages(Outer)+}\text{NPages(Outer)/(Memory-2)}\text{Ã—}\text{NPages(Inner)}$ |
> > |   $\text{Hash Join(HJ)}$    | $\text{[NPages(Outer)+NPages(Inner)]Ã—3}$                     |
> > |        $\text{SMJ}$         | $\text{[NPages(Outer)+NPages(Inner)]Ã—(2Ã—NumPasses+1)}$       |
> >
> > 1.  $\text{NPages(Outer)/(Memory-2)}$è¦==å‘ä¸Šå–æ•´==
> > 2.  æœ€ä¼˜è§£ï¼š$\begin{cases}\text{RAMå¤§å°: }\text{NPages(Outer)+2}\\\\\text{å¼€é”€: Cost=NPages(Outer)+NPages(Inner)}\end{cases}$â€‹â€‹ 
> > 3.  æ³¨æ„$\text{SMJ}$ä¸­å¯èƒ½å‡ºç°$\text{Outer/Inner}$çš„$\text{NumPass}$â€‹ä¸ä¸€æ ·çš„æƒ…å†µï¼Œæ­¤æ—¶å°±è¦åˆ†å¼€è®¨è®º
>
> ## $\textbf{4.3. Pipeline}$â€‹ä¾‹é¢˜
>
> > ### $\textbf{4.3.0. }$å‰ææ¡ä»¶
> >
> > > :one:$\text{SQL}$ä»£ç 
> > >
> > > 1. å…³ç³»ç»“æ„
> > >
> > >    ```sql
> > >    Movie(MovieID, name, genre, releasedate, duration, budget)
> > >    Show(ShowID, dateofShow, MovieID(FK), TheatreID(FK), attend, revenue)
> > >    Theatre(TheatreID, name, city, capacity)
> > >    ```
> > >
> > > 2. æŸ¥è¯¢
> > >
> > >    ```sql
> > >    SELECT *
> > >    FROM Movie AS M, Show AS S, Theatre AS T
> > >    WHERE M.MovieID = S.MovieID
> > >      AND S.TheatreID = T.TheatreID
> > >      AND S.revenue < 60000
> > >      AND M.genre = 'Comedy';
> > >    ```
> > >
> > > :two:å‚æ•°
> > >
> > > 1. $\text{Data}$â€‹å‚æ•°
> > >
> > >    |          $\textbf{\\}$          | $\small\textbf{Genre}$ | $\small\textbf{Revenue}$ | $\small\textbf{Movie}$ | $\small\textbf{Show}$ | $\small\textbf{Theatres}$ |
> > >    | :-----------------------------: | :--------------------: | :----------------------: | :--------------------: | :-------------------: | :-----------------------: |
> > >    |    $\small\text{Num/Tuples}$    |      $\text{10}$       |      $\textbf{\\}$       |     $\text{5000}$      |   $\text{600,000}$    |       $\text{100}$        |
> > >    |      $\small\text{Range}$       |     $\textbf{\\}$      |  $\text{[0, 100,000]}$   |     $\textbf{\\}$      |     $\textbf{\\}$     |       $\textbf{\\}$       |
> > >    |   $\small\text{Tuples/Page}$    |     $\textbf{\\}$      |      $\textbf{\\}$       |      $\text{100}$      |      $\text{10}$      |        $\text{10}$        |
> > >    | $\small\Rightarrow\text{Pages}$ |     $\textbf{\\}$      |      $\textbf{\\}$       |      $\text{50}$       |    $\text{60,000}$    |        $\text{10}$        |
> > >
> > > 2. $\text{Index}$â€‹â€‹â€‹å‚æ•°
> > >
> > >    |    $\textbf{\\}$    |    $\small\textbf{Show.Revenue}$    | $\small\textbf{Movie.MovieID}$ |
> > >    | :-----------------: | :---------------------------------: | :----------------------------: |
> > >    | $\small\text{Type}$ | $\text{Clustered B}^{+}\text{Tree}$ |    $\text{Clustered Hash}$     |
> > >    | $\small\text{Size}$ |          $\text{10Pages}$           |        $\text{10Pages}$        |
> > >
> > > 3. $\text{Join}$â€‹å‚æ•°
> > >
> > >    | $\textbf{Movie}\bowtie{}\textbf{Show}$ | $\textbf{Theater}\bowtie{}\textbf{Show}$ |
> > >    | :------------------------------------: | :--------------------------------------: |
> > >    |        $\text{100Tuples/Page}$         |         $\text{100Tuples/Page}$          |
> > >
> > > 4. $\text{Sort}$å‚æ•°ï¼šæ‰€æœ‰å…³ç³»çš„æ’åºï¼Œ$\text{NumPass=2}$ 
> > >
> > > :three:å…¶å®ƒï¼š$\text{NLJ}$æ˜¯$\text{Page-Oriented}$â€‹çš„
> >
> > ### $\textbf{4.3.1. }$â€‹å‰ææ¡ä»¶
> >
> > > | $\textbf{SQL}$              |   $\textbf{RF}$   | å¤‡æ³¨                                                       |
> > > | :-------------------------- | :---------------: | :--------------------------------------------------------- |
> > > | `M.MovieID = S.MovieID`     | $\cfrac{1}{5000}$ | `MovieID`æ˜¯$\text{Movie(5000}$ä¸ª$\text{)}$çš„$\text{PK}$    |
> > > | `S.TheatreID = T.TheatreID` | $\cfrac{1}{100}$  | `TheatreID`æ˜¯$\text{Theatre(100}$ä¸ª$\text{)}$çš„$\text{PK}$ |
> > > | `S.revenue < 60000`         |  $\cfrac{6}{10}$  | èŒƒå›´$\text{[0, 100,000]}$                                  |
> > > | `M.genre = 'Comedy'`        |  $\cfrac{1}{10}$  | å…±åç§                                                     |
> >
> > ### $\textbf{4.3.2. Plan A}$â€‹ 
> >
> > > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240617124259352.png" alt="image-20240617124259352" style="zoom: 46%;" /> 
> > >
> > > :one:$\text{RSA}$è®¡ç®—
> > >
> > > 1. $\text{NTuples(M)Ã—NTuples(S)Ã—RF(M}\bowtie\text{S)}=5000Ã—600000Ã—\cfrac{1}{5000}$â€‹  
> > > 2. ç»“æœä¸º$600000\text{Tuples}$ï¼Œè®°å¾—è½¬åŒ–ä¸º$\text{6000Pages (100Tuples/Page)}$â€‹
> > >
> > > :two:$\text{B}$å¤„$\text{NLJ(Page-Oriented)}$è®¡ç®—ï¼Œé»˜è®¤å·¦è¾¹ä¸º$\text{Outer}$ 
> > >
> > > 1. $\text{NPages(M)+}\text{NPagees(M)}\text{Ã—}\text{NPages(S)}=50+50Ã—60000$
> > >
> > > 2. ç»“æœä¸º$\text{3000050 I/O}$â€‹  
> > >
> > > :three:$\text{C}$å¤„$\text{SMJ}$è®¡ç®—
> > >
> > > 1. $\text{[RSA+NPages(T)]Ã—(2Ã—NumPasses+1)-RSA=(6000+10)Ã—5-6000}$ 
> > > 2. ç»“æœä¸º$\text{24050 I/O}$â€‹ 
> >
> > ### $\textbf{4.3.2. Plan B}$ 
> >
> > > <img src="https://raw.githubusercontent.com/DANNHIROAKI/New-Picture-Bed/main/img/image-20240617131414662.png" alt="image-20240617131414662" style="zoom:65%;" />  
> > >
> > > :one:$\text{RSA}$è®¡ç®—
> > >
> > > 1. $\text{NTuples(S)Ã—RF(Revenue)=600000Ã—}\cfrac{6}{10}$ 
> > >
> > > 2. ç»“æœä¸º$\text{360000Tuples}$ï¼Œå³$\text{36000Pages}$ 
> > >
> > > :two:$\text{RSB}$è®¡ç®—
> > >
> > > 1. $\text{NTuples(RSA)Ã—NTuples(T)Ã—RF(S}\bowtie\text{T)}=360000Ã—100Ã—\cfrac{1}{100}$  
> > > 2. ç»“æœä¸º$\text{360000Tuples}$ï¼Œä¹Ÿå°±æ˜¯$\text{3600Pages}$â€‹ 
> > >
> > > :three:$\text{C}$å¤„$\text{Index Scan}$å¼€é”€ï¼Œæ³¨æ„æ˜¯$\text{Clustered B}^{+}\text{Tree}$ 
> > >
> > > 1. $\text{[NPages(Index)+NPages(S)]Ã—RF(Revenue)=(10+60000)Ã—}\cfrac{6}{10}$
> > > 2. ç»“æœä¸º$\text{36006 I/O}$ 
> > >
> > > :four:$\text{D}$å¤„$\text{SMJ}$å¼€é”€
> > >
> > > 1. $\text{[RSA+NPages(Inner)]Ã—(2Ã—NumPasses+1)-RSA}=(36000+10)Ã—5-36000$
> > > 2. å¼€é”€ä¸º$\text{144050 I/O}$ 
> > >
> > > :five:$\text{E}$å¤„å¼€é”€$\text{ = HJ}$å¼€é”€$\text{ + Index Scan}$å¼€é”€
> > >
> > > 1. $\text{HJ=[RSB+NPages(M)]Ã—3-RSB-NPages(M)=(3600+50)Ã—2}$
> > > 2. $\text{Index Scan(M)=NPages(M)Ã—RFÃ—2.2}=50Ã—2.2$
> > >    - æ³¨æ„æ­¤å¤„æ˜¯$\text{Clustered Hash}$ï¼Œå¹¶ä¸”$\text{RF=1}$ 
> > >
> > > 3. ç»“æœä¸º$\text{7300+110=7410 I/O}$ 
